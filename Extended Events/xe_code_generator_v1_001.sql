IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.ROUTINES WHERE ROUTINE_NAME = 'xe_code_generator')
	DROP FUNCTION xe_code_generator
GO

/*************************************************
Extended Events Code Generator v1.001 (2010-05-08)
(C) 2009-2010 Adam Machanic

Feedback: mailto:amachanic@gmail.com
Updates: http://sqlblog.com/blogs/adam_machanic

See below for optional SQLCLR create script to
enhance performance of the resultant code when
using the asynchronous_file_target.
*************************************************/
CREATE FUNCTION xe_code_generator
(
	@session_name VARCHAR(200),
	@target_name VARCHAR(200)
)
RETURNS XML
AS
BEGIN
	DECLARE @crlf CHAR(2) = CHAR(13) + CHAR(10);
	DECLARE @use_clr_helper BIT = 
		CASE 
			WHEN 
				@target_name = 'asynchronous_file_target'
				AND EXISTS (SELECT * FROM sys.objects WHERE name = 'xe_event_reader' AND type = 'FT') 
					THEN 1
			ELSE 0
		END;

	RETURN
	(
		SELECT
			'--' + @crlf + 
			'DECLARE ' + @crlf +
			CASE @target_name
				WHEN 'ring_buffer' THEN
					'	@session_name VARCHAR(200) = ''' + @session_name + '''' + @crlf
				WHEN 'asynchronous_file_target' THEN
				(
					SELECT
						'	@path NVARCHAR(260) = ''' + o.file_full_path + '*' + o.file_extension + ''', ' + @crlf +
						'	@mdpath NVARCHAR(260) = ''' + o.metadata_full_path + '*' + o.metadata_extension + ''', ' + @crlf +
						'	@initial_file_name NVARCHAR(260) = NULL, ' + @crlf +
						'	@initial_offset BIGINT = NULL ' + @crlf
					FROM 
					(
						SELECT
							file_full_path,
							file_extension,
							COALESCE(metadata_full_path, file_full_path) AS metadata_full_path,
							COALESCE(metadata_extension, '.xem') AS metadata_extension
						FROM
						(
							SELECT
								MIN
								(
									CASE
										WHEN name = 'filename' THEN file_full_path
										ELSE NULL
									END
								) AS file_full_path,
								MIN
								(
									CASE
										WHEN name = 'filename' THEN file_extension
										ELSE NULL
									END
								) AS file_extension,
								MIN
								(
									CASE
										WHEN name = 'metadatafile' THEN file_full_path
										ELSE NULL
									END
								) AS metadata_full_path,
								MIN
								(
									CASE
										WHEN name = 'metadatafile' THEN file_extension
										ELSE NULL
									END
								) AS metadata_extension
							FROM
							(
								SELECT
									name,
									path_to_file +
										COALESCE
										(
											first_chunk,
											second_chunk
										) AS file_full_path,
									COALESCE
									(
										'.' + 
											NULLIF
											(
												second_chunk, 	
												COALESCE
												(
													first_chunk,
													second_chunk
												)
											), 
										''
									) AS file_extension
								FROM
								(
									SELECT
										name,
										LEFT(filepath, LEN(filepath) - file_starting_point) AS path_to_file,
										PARSENAME(RIGHT(filepath, file_starting_point), 2) AS first_chunk,
										PARSENAME(RIGHT(filepath, file_starting_point), 1) AS second_chunk
									FROM
									(
										SELECT 
											f.name,
											CONVERT(VARCHAR(128), f.value) AS filepath,
											CHARINDEX('\', REVERSE(CONVERT(VARCHAR(128), f.value))) - 1 AS file_starting_point
										FROM sys.server_event_session_targets t 
										JOIN sys.server_event_session_fields f ON
											t.event_session_id = f.event_session_id
											AND t.name = 'asynchronous_file_target'
											AND f.name IN ('filename', 'metadatafile')
										JOIN sys.server_event_sessions s ON
											s.event_session_id = t.event_session_id
											AND s.name = @session_name
									) n
								) m
							) p
						) q
					) o
				)
				ELSE NULL
			END + @crlf + 
			'SELECT ' + @crlf + 
			'	pivoted_data.* ' + @crlf + 
			'FROM ' + @crlf + 
			'( ' + @crlf + 			
			'	SELECT ' + @crlf + 
			'		MIN(event_name) as event_name, ' + @crlf + 
			'		MIN(event_timestamp) as event_timestamp, ' + @crlf + 
				CASE
					WHEN
						EXISTS
						(
							SELECT *
							FROM sys.dm_xe_sessions s
							WHERE
								s.name = @session_name
								AND s.flag_desc like '%causality%'
						)
						THEN
						'		CONVERT(UNIQUEIDENTIFIER, MIN(LEFT(attach_activity_id, 36))) AS activity_id, ' + @crlf + 
						'		CONVERT(INT, MIN(RIGHT(attach_activity_id, LEN(attach_activity_id) - 37))) AS activity_sequence, '
					ELSE 
						'		unique_event_id, ' 
				END + @crlf + 
				CASE
					WHEN @target_name = 'asynchronous_file_target' THEN
						'		MIN(file_name) AS file_name, ' + @crlf +
						'		MIN(file_offset) AS file_offset, ' + @crlf
					ELSE ''
				END +
				STUFF(c.value('.[1]', 'varchar(max)'), LEN(c.value('.[1]', 'varchar(max)')) - 2, 3, '') + @crlf +
			'	FROM ' + @crlf + 
			'	( ' + @crlf + 
			'		SELECT ' + @crlf + 
			'			*' + 
						CASE
							WHEN
								EXISTS
								(
									SELECT *
									FROM sys.dm_xe_sessions s
									WHERE
										s.name = @session_name
										AND s.flag_desc like '%causality%'
								)
								AND @use_clr_helper = 0
								THEN
								', ' + @crlf +
								'			MIN ' + @crlf + 
								'			( ' + @crlf + 
								'				CASE ' + @crlf + 
								'					WHEN d_name = ''attach_activity_id'' THEN d_value ' + @crlf + 
								'					ELSE NULL ' + @crlf + 
								'				END ' + @crlf + 
								'			) OVER (PARTITION BY unique_event_id) AS attach_activity_id ' + @crlf
							WHEN @use_clr_helper = 1 THEN @crlf
							ELSE
								', ' + @crlf +
								'			CONVERT(VARCHAR(400), NULL) AS attach_activity_id ' + @crlf
						END + 
			'		FROM ' + @crlf + 
			'		( ' + @crlf +
			'			SELECT ' + @crlf + 
							CASE
								WHEN @target_name = 'asynchronous_file_target' THEN 
									'				the_xml.event_name, ' + @crlf + 
									'				the_xml.file_name, ' + @crlf +
									'				the_xml.file_offset, ' + @crlf +
									'				the_xml.unique_event_id, ' + @crlf +
									CASE 
										WHEN @use_clr_helper = 0 THEN
											'				the_xml.event_timestamp, ' + @crlf
										ELSE ''
									END
								ELSE 
									'				event.value(''(@name)[1]'', ''VARCHAR(400)'') as event_name, ' + @crlf + 
									'				event.value(''(@timestamp)[1]'', ''DATETIME'') as event_timestamp, ' + @crlf + 
									'				DENSE_RANK() OVER (ORDER BY event) AS unique_event_id, ' + @crlf
							END + 
				CASE 
					WHEN @use_clr_helper = 1 THEN
						'				event_timestamp, ' + @crlf + 
						'				data_name AS d_name, ' + @crlf +
						'				data_package AS d_package, ' + @crlf + 
						'				data_value AS d_value, ' + @crlf +
						'				data_text AS d_text, ' + @crlf +
						'				attach_activity_id ' + @crlf
					ELSE
						'				n.value(''(@name)[1]'', ''VARCHAR(400)'') AS d_name, ' + @crlf + 
						'				n.value(''(@package)[1]'', ''VARCHAR(400)'') AS d_package, ' + @crlf + 
						'				n.value(''((value)[1]/text())[1]'', ''VARCHAR(MAX)'') AS d_value, ' + @crlf + 
						'				n.value(''((text)[1]/text())[1]'', ''VARCHAR(MAX)'') AS d_text ' + @crlf
				END +
			'			FROM ' + @crlf + 
			'			( ' + @crlf + 
							CASE
								WHEN @target_name = 'ring_buffer' THEN
									'				SELECT ' + @crlf + 
									'					( ' + @crlf + 
									'						SELECT ' + @crlf + 
									'							CONVERT(xml, target_data) ' + @crlf + 
									'						FROM sys.dm_xe_session_targets st ' + @crlf + 
									'						JOIN sys.dm_xe_sessions s ON ' + @crlf + 
									'							s.address = st.event_session_address ' + @crlf + 
									'						WHERE ' + @crlf + 
									'							s.name = @session_name ' + @crlf +
									'							AND st.target_name = ''ring_buffer'' ' + @crlf + 
									'					) AS [x] ' + @crlf + 
									'				FOR XML PATH(''''), TYPE ' 
								WHEN @target_name = 'asynchronous_file_target' THEN
									'				SELECT ' + @crlf + 
									'					CONVERT(xml, event_data), ' + @crlf + 
									CASE 
										WHEN @use_clr_helper = 0 THEN
											'					CONVERT(xml, event_data).value(''(event/@timestamp)[1]'', ''DATETIME'') AS event_timestamp, ' + @crlf
										ELSE ''
									END +
									'					object_name, ' + @crlf +
									'					ROW_NUMBER() OVER (ORDER BY (SELECT 1)), ' + @crlf + 
									'					file_name, ' + @crlf +
									'					file_offset ' + @crlf +
									'				FROM sys.fn_xe_file_target_read_file (@path, @mdpath, @initial_file_name, @initial_offset) ' 
								--only ring_buffer and asynchronous_file_target currently supported
								ELSE NULL
							END + @crlf + 
			'			) AS the_xml(' + 
			CASE 
				WHEN @target_name <> 'asynchronous_file_target' THEN 'x' 
				ELSE 
					'event, ' + 
					CASE 
						WHEN @use_clr_helper = 0 THEN 'event_timestamp, ' 
						ELSE '' 
					END + 'event_name, unique_event_id, file_name, file_offset' 
			END + ') ' + @crlf + 
			CASE WHEN @target_name <> 'asynchronous_file_target' THEN '			CROSS APPLY x.nodes(''//event'') e (event) ' + @crlf ELSE '' END + 
			CASE 
				WHEN @use_clr_helper = 1 THEN
					'			CROSS APPLY xe_event_reader(event) AS q ' + @crlf
				ELSE
					'			CROSS APPLY event.nodes(''' + CASE WHEN @target_name <> 'asynchronous_file_target' THEN '*' ELSE 'event/*' END + ''') AS q (n) ' + @crlf
			END +
			'		) AS data_data ' + @crlf + 
			'	) AS activity_data ' + @crlf + 
			'	GROUP BY ' + @crlf + 
			'		unique_event_id ' + @crlf + 
			') AS pivoted_data; ' + @crlf + '--' AS [processing-instruction(query)]
		FROM
		(
			SELECT
				the_list as [text()]
			FROM
			(
				SELECT TOP(2147483647)
					'		CONVERT ' + @crlf + 
					'		( ' + @crlf + 
					'			' + 
								CASE column_type
									WHEN 'int8' THEN 'TINYINT'
									WHEN 'int16' THEN 'SMALLINT'
									WHEN 'int32' THEN 'INT'
									WHEN 'int64' THEN 'BIGINT'
									WHEN 'uint8' THEN 'SMALLINT'
									WHEN 'uint16' THEN 'INT'
									WHEN 'uint32' THEN 'BIGINT'
									WHEN 'uint64' THEN 'DECIMAL(28,0)'
									WHEN 'float32' THEN 'FLOAT(24)'
									WHEN 'float64' THEN 'FLOAT(53)'
									ELSE 
										CASE
											WHEN column_name = 'tsql_stack' THEN 'XML'
											ELSE 'VARCHAR(MAX)'
										END
								END + ', ' + @crlf +								
					'			MIN ' + @crlf + 
					'			( ' + @crlf + 
					'				CASE ' + @crlf + 
					'					WHEN ' + @crlf + 
					'						event_name = ''' + event_name + ''' and ' + @crlf + 
					'						d_name = ''' + column_name + ''' and ' + @crlf + 
					'						d_package IS ' + CASE WHEN object_type = 'action' THEN 'NOT ' ELSE '' END + 'NULL ' + @crlf + 
					'							THEN ' + 
											CASE
												WHEN object_type = 'map' THEN 'd_text'
												ELSE 'd_value' 
											END + @crlf + 
					'				END ' + @crlf + 
					'			) ' + @crlf + 
					'		) AS [' + event_name + '.' + column_name + '],' + @crlf
				FROM
				(
					SELECT
						se.name AS event_name,
						oc.name AS column_name,
						oc.type_name AS column_type,
						o.object_type
					FROM sys.server_event_session_events se
					JOIN sys.server_event_sessions s ON
						s.event_session_id = se.event_session_id
					JOIN sys.dm_xe_packages p ON
						p.name = se.package
					JOIN sys.dm_xe_object_columns oc ON 
						oc.object_package_guid = p.guid
						AND oc.object_name = se.name
					JOIN sys.dm_xe_objects o ON
						o.name = oc.type_name
						AND o.package_guid = oc.type_package_guid
						AND o.object_type IN ('type', 'map')
					WHERE 
						s.name = @session_name
						AND oc.column_type = 'data'
					
					UNION ALL
					
					SELECT 
						ea.event_name,
						ea.action_name AS column_name,
						'action' AS column_type,
						'action' AS object_type
					FROM sys.dm_xe_session_event_actions ea
					JOIN sys.dm_xe_sessions s ON
						s.address = ea.event_session_address
					WHERE 
						s.name = @session_name
				) event_data
				ORDER BY
					event_name,
					column_name
			) u (the_list)
			FOR XML PATH(''), TYPE
		) column_list (c)
		FOR XML PATH('')
	)
END
GO

/*************************************************
OPTIONAL: SQLCLR Helper Function

This function allows the resultant code to read
from the file target 3-5x faster than is possible
using only the built-in functions.
*************************************************/
/*
IF EXISTS (SELECT * FROM sys.objects WHERE name = 'xe_event_reader')
	DROP FUNCTION xe_event_reader
GO

IF EXISTS (SELECT * FROM sys.assemblies WHERE name = 'xe_event_reader')
	DROP ASSEMBLY xe_event_reader
GO

CREATE ASSEMBLY xe_event_reader
FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C01030070825F4A0000000000000000E00002210B0108000012000000060000000000002E310000002000000040000000004000002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000D830000053000000004000009803000000000000000000000000000000000000006000000C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E7465787400000034110000002000000012000000020000000000000000000000000000200000602E7273726300000098030000004000000004000000140000000000000000000000000000400000402E72656C6F6300000C000000006000000002000000180000000000000000000000000000400000420000000000000000000000000000000010310000000000004800000002000500C0230000180D00000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000133004009101000001000011026F0F00000A0A066F1000000A260672010000706F1100000A6F1200000A281300000A0B140C731400000A0D384C010000066F1500000A251306392801000011067215000070281600000A2D131106721F000070281600000A2D6538070100001A8D18000001130411041606722D0000706F1100000AA20672370000706F1700000A26066F1800000A2D0A110418066F1900000AA20672430000706F1700000A26066F1800000A2D0A110419066F1900000AA20911046F1A00000A38BD00000006722D0000706F1100000A724D000070281600000A2C240672370000706F1700000A26066F1900000A0C0672430000706F1700000A2638820000001A8D18000001130511051606722D0000706F1100000AA21105170672730000706F1100000AA20672370000706F1700000A26066F1800000A2D0A110518066F1900000AA20672430000706F1700000A26066F1800000A2D0A110519066F1900000AA20911056F1A00000A2B167283000070066F1500000A281B00000A731C00000A7A0628020000063AA9FEFFFF07080973050000062AD62B29026F1D00000A173302172A026F1D00000A1F0F3314026F1500000A72D1000070281600000A2C02162A026F1000000A2DCF162A001330020071000000020000110274040000020A03066F0A000006281E00000A810500000104066F0B000006281F00000A810600000105066F0C000006281F00000A81060000010E04066F0D000006281F00000A81060000010E05066F0E000006281F00000A81060000010E06066F0F000006281F00000A81060000012A1E02282000000A2ABE02157D0500000402282000000A02037D0200000402047D0300000402057D04000004020273090000067D010000042A1E027B010000042A000000133003001F0000000300001102257B050000041758250A7D0500000406027B040000046F2100000AFE042A2202157D050000042A3A02282000000A02037D060000042A32027B060000047B020000042A7A027B060000047B04000004027B060000047B050000046F2200000A169A2A7A027B060000047B04000004027B060000047B050000046F2200000A179A2A7A027B060000047B04000004027B060000047B050000046F2200000A189A2A7A027B060000047B04000004027B060000047B050000046F2200000A199A2A32027B060000047B030000042A00000042534A4201000100000000000C00000076322E302E35303732370000000005006C00000050040000237E0000BC040000D404000023537472696E67730000000090090000E000000023555300700A0000100000002347554944000000800A00009802000023426C6F6200000000000000020000015717A2090902000000FA013300160000010000001A00000004000000060000000F0000000D00000001000000220000000B000000030000000200000007000000070000000100000001000000030000000200000000000A000100000000000600590052000600730060000A00A0008B000E00C200B7000A00DC008B000A00E8008B0006000D0152000600310116010600530234020600720260020600890260020600A60260020600C50260020600DE0260020600F702600206001203600206002D03600206004603340206005A0360020600930373030600B30373030A00EC03D10306002504520006004104520006008D0452000E00A504B7000000000001000000000001000100010010001E00000005000100010003001000330000000500010005000200100041000000050006000900210038013F0021003C01430021004C01470021005F014A0001006B01520021009B0167005020000000009600A7000A000100ED21000000009100CC00110002002422000000009600F20017000300A12200000000861807012E000A00A922000000008618070132000A00D92200000000E609780155000D00E42200000000E601840159000D000F2300000000E6018D012E000D001823000000008618070161000D0027230000000086089D016B000E003423000000008608B10170000E005323000000008608BF0170000E007223000000008608D00170000E009123000000008608DF0170000E00B023000000008608ED0170000E00000001009B01000001003002000001003202020002003C01020003000402020004000E02020005001B02020006002602020007004C01000001003C01000002004C01000003005F01000001009B0103000900490007012E00510007017D00590007017D00610007017D00690007017D00710007017D00790007017D00810007017D00890007017D00910007018200990007017D00A10007018700A90007012E00B10007012E0019000104C80121000E04590021001304CD0109001C047000B9002D04D2010C0007012E00210038047000C1004804DF0121005404E5012100640459002100770470000C008204EA01C1008604F001C90007017D002100B10409022900BE040E023100BE041502090007012E000C00CA0420020C0013042802200073008C002E0033002E022E001B0043022E00230043022E002B0049022E0013002E022E003B0052022E00430043022E00530043022E0063006D022E006B007602F6011B0224020300010004000200000093015D0000003C01740000000402790000000E02790000001B02790000002602790000004C01790002000600030002000A00050002000B00070002000C00090002000D000B0002000E000D0002000F000F00D80104800000010000009C0D5067000000000000A7000000020000000000000000000000010049000000000002000000000000000000000001007F00000000000200000000000000000000000100B7000000000003000200040003000000003C4D6F64756C653E0078655F6576656E745F7265616465722E646C6C0055736572446566696E656446756E6374696F6E730078655F656E756D657261746F7200726573756C7473006D73636F726C69620053797374656D004F626A6563740053797374656D2E436F6C6C656374696F6E730049456E756D657261746F720053797374656D2E446174610053797374656D2E446174612E53716C54797065730053716C586D6C0078655F6576656E745F7265616465720053797374656D2E586D6C00586D6C5265616465720046696E644E657874456C656D656E740053716C4461746554696D650053716C537472696E670078655F6576656E745F7265616465725F66696C6C002E63746F72004461746554696D650053797374656D2E436F6C6C656374696F6E732E47656E65726963004C697374603100726573006576656E745F74696D657374616D70006174746163685F61637469766974795F696400646174615F76616C7565730063757272656E745F6974656D006765745F43757272656E74004D6F76654E6578740052657365740043757272656E740078006765745F6576656E745F74696D657374616D70006765745F646174615F6E616D65006765745F646174615F7061636B616765006765745F646174615F76616C7565006765745F646174615F74657874006765745F6174746163685F61637469766974795F696400646174615F6E616D6500646174615F7061636B61676500646174615F76616C756500646174615F746578740072006F0053797374656D2E52756E74696D652E496E7465726F705365727669636573004F75744174747269627574650053797374656D2E5265666C656374696F6E00417373656D626C795469746C6541747472696275746500417373656D626C794465736372697074696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E41747472696275746500417373656D626C79436F6D70616E7941747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C7954726164656D61726B41747472696275746500417373656D626C7943756C7475726541747472696275746500436F6D56697369626C6541747472696275746500417373656D626C7956657273696F6E4174747269627574650053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465004D6963726F736F66742E53716C5365727665722E5365727665720053716C46756E6374696F6E417474726962757465004372656174655265616465720052656164006765745F4974656D00546F537472696E6700436F6E7665727400546F4461746554696D65006765745F4E616D6500537472696E67006F705F457175616C6974790052656164546F466F6C6C6F77696E67006765745F4973456D707479456C656D656E740052656164537472696E670041646400436F6E636174004E6F74496D706C656D656E746564457863657074696F6E00586D6C4E6F646554797065006765745F4E6F646554797065006F705F496D706C69636974006765745F436F756E74000013740069006D0065007300740061006D00700000096400610074006100000D61006300740069006F006E0000096E0061006D006500000B760061006C00750065000009740065007800740000256100740074006100630068005F00610063007400690076006900740079005F0069006400000F7000610063006B00610067006500004D4E006F0020006200650068006100760069006F007200200064006500660069006E0065006400200066006F007200200065006C0065006D0065006E007400200074007900700065003A002000000B6500760065006E00740000000000C90880B02645B54A9A5B01BFE6523D180008B77A5C561934E0890600011209120D050001021211160007011C101115101119101119101119101119101119032000010C200301111D0E151221011D0E030612100306111D02060E0706151221011D0E0206080320001C032000020328001C05200101120C0306120C042000111D0320000E042800111D0328000E042001010E04200101020420010108813A01000200540E1146696C6C526F774D6574686F644E616D651478655F6576656E745F7265616465725F66696C6C540E0F5461626C65446566696E6974696F6E80F90D0A2020202020202020202020206576656E745F74696D657374616D70206461746574696D652C200D0A202020202020202020202020646174615F6E616D65206E7661726368617228343030292C200D0A202020202020202020202020646174615F7061636B616765206E7661726368617228343030292C200D0A202020202020202020202020646174615F76616C7565206E766172636861722834303030292C200D0A202020202020202020202020646174615F74657874206E766172636861722834303030292C200D0A2020202020202020202020206174746163685F61637469766974795F6964206E7661726368617228343030302904200012110420010E0E050001111D0E06151221011D0E050002020E0E042001020E0520010113000500020E0E0E1207071211111D0E151221011D0E1D0E1D0E0E04200011690600011115111D05000111190E040701121003200008030701080520011300081401000F78655F6576656E745F726561646572000005010000000008010003474D4F00001A010015436F7079726967687420C2A920474D4F203230303900000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010000000031000000000000000000001E3100000020000000000000000000000000000000000000000000001031000000000000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000400300000000000000000000400334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE000001000000010050679C0D0000010050679C0D3F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004A0020000010053007400720069006E006700460069006C00650049006E0066006F0000007C020000010030003000300030003000340062003000000028000400010043006F006D00700061006E0079004E0061006D0065000000000047004D004F000000480010000100460069006C0065004400650073006300720069007000740069006F006E0000000000780065005F006500760065006E0074005F00720065006100640065007200000040000F000100460069006C006500560065007200730069006F006E000000000031002E0030002E0033003400380034002E00320036003400340038000000000048001400010049006E007400650072006E0061006C004E0061006D0065000000780065005F006500760065006E0074005F007200650061006400650072002E0064006C006C0000005000150001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A900200047004D004F0020003200300030003900000000005000140001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000780065005F006500760065006E0074005F007200650061006400650072002E0064006C006C000000400010000100500072006F0064007500630074004E0061006D00650000000000780065005F006500760065006E0074005F00720065006100640065007200000044000F000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0033003400380034002E00320036003400340038000000000048000F00010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0033003400380034002E0032003600340034003800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000303100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
WITH PERMISSION_SET = SAFE
GO

CREATE FUNCTION xe_event_reader
(
	@x XML
)
RETURNS TABLE
(
	event_timestamp datetime, 
	data_name nvarchar(400), 
	data_package nvarchar(400), 
	data_value nvarchar(MAX), 
	data_text nvarchar(MAX), 
	attach_activity_id nvarchar(4000)
)
AS EXTERNAL NAME xe_event_reader.UserDefinedFunctions.xe_event_reader
GO
*/